<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Patients — BrightCare</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/medical_clinic/public/css/appointments.css">
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Main">
      <div class="brand">
        <div class="brand-logo">BC</div>
        <div class="brand-name">BrightCare</div>
      </div>
      <nav class="nav">
        <div class="nav-section">
          <div class="nav-title">Appointments</div>
          <a class="nav-link" href="/medical_clinic/public/html/appointments.html">View</a>
          <a class="nav-link" href="/medical_clinic/public/html/appointment_new.html">Add</a>
        </div>
        <div class="nav-section">
          <div class="nav-title">Patients</div>
          <a class="nav-link active" href="/medical_clinic/public/html/patients.html">View</a>
          <a class="nav-link" href="/medical_clinic/public/html/patient_new.html">Add</a>
        </div>
        <div class="nav-section">
          <div class="nav-title">Rooms</div>
          <a class="nav-link" href="/medical_clinic/public/html/rooms.html">View</a>
          <a class="nav-link" href="/medical_clinic/public/html/room_new.html">Add</a>
        </div>
        <div class="nav-section">
          <div class="nav-title">Doctors</div>
          <a class="nav-link" href="/medical_clinic/public/html/doctors.html">View</a>
          <a class="nav-link" href="/medical_clinic/public/html/doctor_new.html">Add</a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-btn" type="button">Log out</button>
      </div>
    </aside>

    <!-- Page -->
    <main class="container">
      <header class="page-header">
        <h1>Patients</h1>
        <a class="link-new" href="./patient_new.html">+ New Patient</a>
      </header>

      <section class="filters card">
        <div class="filters-grid">
          <div class="filters-actions" style="grid-column: 1 / -1;">
            <input type="text" id="q" placeholder="Search by name/phone/email/address…" style="width:100%;">
          </div>
        </div>
      </section>

      <div id="statusMsg" class="status-msg"></div>

      <div class="table-card">
        <div class="table-wrap">
          <table class="data-table" id="patientsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>DOB</th>
                <th>Address</th>
              </tr>
            </thead>
            <tbody id="patientsBody">
              <tr><td colspan="5" class="empty">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Auth + logout
    (function(){
      const t = localStorage.getItem('token') || sessionStorage.getItem('token');
      if (!t) { location.href = './login.html'; return; }
      const btn = document.getElementById('logoutBtn');
      if (btn) btn.addEventListener('click', () => {
        localStorage.removeItem('token'); sessionStorage.removeItem('token');
        location.href = './login.html';
      });
    })();

    (function(){
      const API = '/medical_clinic/api/patients.php';
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      const tbody = document.getElementById('patientsBody');
      const status = document.getElementById('statusMsg');
      const q = document.getElementById('q');

      async function load(){
        try {
          status.textContent = 'Loading…';
          tbody.innerHTML = '<tr><td class="empty" colspan="5">Loading…</td></tr>';
          const url = new URL(API, location.origin);
          if (q.value.trim()) url.searchParams.set('q', q.value.trim());
          const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token }});
          if (!res.ok) throw new Error('Failed to load patients');
          const data = await res.json();
          const rows = (data?.patients) || data || []; // support both shapes
          if (!rows.length) {
            tbody.innerHTML = '<tr><td class="empty" colspan="5">No patients found</td></tr>';
          } else {
            tbody.innerHTML = rows.map(p => `
              <tr>
                <td>${escapeHtml((p.first_name||'') + ' ' + (p.last_name||''))}</td>
                <td>${escapeHtml(p.phone||'')}</td>
                <td>${escapeHtml(p.email||'')}</td>
                <td>${escapeHtml(p.dob||'')}</td>
                <td>${escapeHtml(p.address||'')}</td>
              </tr>
            `).join('');
          }
          status.textContent = `${rows.length} patient(s)`;
        } catch(e) {
          console.error(e);
          status.textContent = e.message || 'Error loading patients';
          tbody.innerHTML = '<tr><td class="empty" colspan="5">Unable to load</td></tr>';
        }
      }

      function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
      q.addEventListener('input', debounce(load, 300));
      function escapeHtml(s){return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
      load();
    })();
  </script>
</body>
</html>
