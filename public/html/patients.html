<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Patients — BrightCare</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/medical_clinic/public/css/appointments.css">
</head>
<body>
<div class="layout">
  <aside class="sidebar" role="navigation" aria-label="Main">
    <div class="brand"><div class="brand-logo">BC</div><div class="brand-name">BrightCare</div></div>
    <nav class="nav">
      <div class="nav-section">
        <div class="nav-title">Appointments</div>
        <a class="nav-link" href="./appointments_calendar.html">Calendar</a>
        <a class="nav-link" href="/medical_clinic/public/html/appointments.html">View</a>
        <a class="nav-link" href="/medical_clinic/public/html/appointment_new.html">Add</a>
      </div>
      <div class="nav-section">
        <div class="nav-title">Patients</div>
        <a class="nav-link active" href="/medical_clinic/public/html/patients.html">View</a>
        <a class="nav-link" href="/medical_clinic/public/html/patient_new.html">Add</a>
      </div>
      <div class="nav-section">
        <div class="nav-title">Doctors</div>
        <a class="nav-link" href="/medical_clinic/public/html/doctors.html">View</a>
        <a class="nav-link" href="/medical_clinic/public/html/doctor_new.html">Add</a>
      </div>
      <div class="nav-section">
        <div class="nav-title">Rooms</div>
        <a class="nav-link" href="/medical_clinic/public/html/rooms.html">View</a>
        <a class="nav-link" href="/medical_clinic/public/html/room_new.html">Add</a>
      </div>
    </nav>
    <div class="sidebar-footer"><button id="logoutBtn" class="logout-btn" type="button">Log out</button></div>
  </aside>

  <main class="container">
    <header class="page-header">
      <h1>Patients</h1>
      <a class="link-new" href="./patient_new.html">+ New Patient</a>
    </header>

    <div class="filters card">
      <input id="q" placeholder="Search name / phone / email / ID" />
      <button id="searchBtn" class="btn-secondary">Search</button>
      <span id="statusMsg" class="muted"></span>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table class="table" id="patientsTable" aria-label="Patients table">
          <thead>
            <tr>
              <th style="width:90px;">ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>DOB</th>
              <th style="width:240px;">Actions</th>
            </tr>
          </thead>
          <tbody id="patientsBody">
            <tr><td colspan="6" class="empty">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<script>
  // Auth guard + logout
  (function(){
    const t = localStorage.getItem('token') || sessionStorage.getItem('token');
    if (!t) { location.href = './login.html'; return; }
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('token'); sessionStorage.removeItem('token'); location.href='./login.html';
    });
  })();

  (function(){
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    const API = '/medical_clinic/api/patients.php';
    const qInput = document.getElementById('q');
    const statusMsg = document.getElementById('statusMsg');
    const tbody = document.getElementById('patientsBody');

    async function load(q='') {
      statusMsg.textContent = 'Loading…';
      tbody.innerHTML = `<tr><td colspan="6" class="empty">Loading…</td></tr>`;
      const url = q ? `${API}?q=${encodeURIComponent(q)}` : API;
      try {
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token }});
        const data = await res.json();
        const rows = data.patients || [];
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="empty">No patients found</td></tr>`;
          statusMsg.textContent = '0 results';
          return;
        }
        tbody.innerHTML = rows.map(p => {
          const name = `${p.first_name || ''} ${p.last_name || ''}`.trim();
          const id = p.id;
          const dob = p.dob || '';
          const phone = p.phone || '';
          const email = p.email || '';
          return `
            <tr>
              <td>${id}</td>
              <td>${escapeHtml(name)}</td>
              <td>${escapeHtml(phone)}</td>
              <td>${escapeHtml(email)}</td>
              <td>${escapeHtml(dob)}</td>
              <td>
                <a class="small-btn" href="./appointment_new.html?patientId=${encodeURIComponent(id)}">Add appointment</a>
                <a class="small-btn btn-secondary" href="./patient_view.html?id=${encodeURIComponent(id)}">View</a>
              </td>
            </tr>
          `;
        }).join('');
        statusMsg.textContent = `${rows.length} result(s)`;
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Error loading patients</td></tr>`;
        statusMsg.textContent = 'Error';
      }
    }

    document.getElementById('searchBtn').addEventListener('click', ()=> load(qInput.value.trim()));
    qInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') load(qInput.value.trim()); });

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }

    load();
  })();
</script>
</body>
</html>
