<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>New Patient — BrightCare</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/medical_clinic/public/css/appointments.css">
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Main">
      <div class="brand">
        <div class="brand-logo">BC</div>
        <div class="brand-name">BrightCare</div>
      </div>
      <nav class="nav">
        <div class="nav-section">
          <div class="nav-title">Appointments</div>
          <a class="nav-link" href="./appointments_calendar.html">Calendar</a>
          <a class="nav-link" href="/medical_clinic/public/html/appointments.html">View</a>
          <a class="nav-link" href="/medical_clinic/public/html/appointment_new.html">Add</a>
        </div>
        <div class="nav-section">
          <div class="nav-title">Patients</div>
          <a class="nav-link" href="/medical_clinic/public/html/patients.html">View</a>
          <a class="nav-link active" href="/medical_clinic/public/html/patient_new.html">Add</a>
        </div>
        <div class="nav-section">
          <div class="nav-title">Rooms</div>
          <a class="nav-link" href="/medical_clinic/public/html/rooms.html">View</a>
          <a class="nav-link" href="/medical_clinic/public/html/room_new.html">Add</a>
        </div>
        <div class="nav-section">
          <div class="nav-title">Doctors</div>
          <a class="nav-link" href="/medical_clinic/public/html/doctors.html">View</a>
          <a class="nav-link" href="/medical_clinic/public/html/doctor_new.html">Add</a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-btn" type="button">Log out</button>
      </div>
    </aside>

    <!-- Page -->
    <main class="container">
      <header class="page-header">
        <h1>New Patient</h1>
        <a class="link-new" href="./patients.html">← Back to Patients</a>
      </header>

      <form id="patientForm" class="card card-form" novalidate>
        <div class="grid-3">
          <label> First name
            <input id="first_name" required>
          </label>
          <label> Last name
            <input id="last_name" required>
          </label>
          <label> Phone
            <input id="phone" inputmode="tel">
          </label>
          <label> Email
            <input id="email" type="email">
          </label>
          <label> DOB
            <input id="dob" type="date">
          </label>
          <label> Address
            <input id="address">
          </label>
        </div>

        <div class="form-actions">
          <div id="formMsg" class="form-msg"></div>
          <button type="button" class="btn-secondary" onclick="location.href='./patients.html'">Cancel</button>
          <button type="submit" class="btn-primary">Create</button>
        </div>
      </form>
    </main>
  </div>

  <script>
    // Auth + logout
    (function(){
      const t = localStorage.getItem('token') || sessionStorage.getItem('token');
      if (!t) { location.href = './login.html'; return; }
      const btn = document.getElementById('logoutBtn');
      if (btn) btn.addEventListener('click', () => {
        localStorage.removeItem('token'); sessionStorage.removeItem('token');
        location.href = './login.html';
      });
    })();

    (function(){
      const API = '/medical_clinic/api/patient_create.php'; // ensure this endpoint exists server-side
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');

      const form = document.getElementById('patientForm');
      const msg  = document.getElementById('formMsg');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.textContent = 'Saving…';

        const payload = {
          first_name: document.getElementById('first_name').value.trim(),
          last_name:  document.getElementById('last_name').value.trim(),
          phone:      document.getElementById('phone').value.trim(),
          email:      document.getElementById('email').value.trim(),
          dob:        document.getElementById('dob').value || null,
          address:    document.getElementById('address').value.trim()
        };

        try {
          const res = await fetch(API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(data.error || 'Failed to create patient');
          msg.style.color = '#0E4B50';
          msg.textContent = 'Created!';
          setTimeout(()=> location.href='./patients.html', 400);
        } catch(err) {
          console.error(err);
          msg.style.color = '#B00020';
          msg.textContent = err.message || 'Error';
        }
      });
    })();
  </script>
</body>
</html>
